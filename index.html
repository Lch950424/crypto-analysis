<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoinW 100x AI 終端</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body class="bg-black text-white p-2 font-mono flex flex-col h-screen">

    <div class="grid grid-cols-2 gap-2 mb-2">
        <div class="bg-zinc-900 p-3 rounded-lg border-l-4 border-green-500">
            <div class="text-[10px] text-zinc-500 uppercase font-bold">CoinW BTC/USDT</div>
            <div id="btc-price" class="text-3xl font-bold text-green-400">0.00</div>
        </div>
        <div class="bg-zinc-900 p-3 rounded-lg border-l-4 border-blue-500">
            <div class="text-[10px] text-zinc-500 uppercase font-bold">CoinW ETH/USDT</div>
            <div id="eth-price" class="text-3xl font-bold text-blue-400">0.00</div>
        </div>
    </div>

    <div class="flex-1 bg-zinc-900 rounded-lg border border-zinc-800 relative mb-2">
        <div id="main-chart" class="w-full h-full"></div>
        <div class="absolute top-2 left-2 bg-black/60 p-2 rounded text-[10px] space-y-1 z-10">
            <div class="text-orange-400">● FVG Detector Active</div>
            <div class="text-purple-400">● SMC/BOS Logic Ready</div>
        </div>
    </div>

    <div class="h-40 flex gap-2">
        <div class="flex-1 bg-zinc-900 p-3 rounded-lg border border-zinc-800 overflow-y-auto">
            <h3 class="text-xs font-bold text-yellow-500 mb-2 uppercase tracking-wider">AI SMC 實時日誌</h3>
            <div id="smc-logs" class="text-[10px] space-y-1 text-zinc-400">等待 API 數據流入...</div>
        </div>
        <div class="w-72 bg-blue-900/10 p-3 rounded-lg border border-blue-500/50">
            <h3 class="text-xs font-bold text-blue-400 mb-2 uppercase">100x 掛單建議</h3>
            <div id="ai-advice" class="text-[11px] text-blue-100">分析中...</div>
            <div class="mt-2 grid grid-cols-2 gap-1">
                <div class="bg-black/40 p-1 rounded text-[10px]">入場: <span id="entry-val">--</span></div>
                <div class="bg-black/40 p-1 rounded text-[10px]">止損: <span id="sl-val" class="text-red-400">--</span></div>
            </div>
        </div>
    </div>

    <script>
        // 1. 初始化圖表
        const chart = LightweightCharts.createChart(document.getElementById('main-chart'), {
            layout: { background: { color: '#000' }, textColor: '#aaa' },
            grid: { vertLines: { color: '#111' }, horzLines: { color: '#111' } },
            timeScale: { timeVisible: true, secondsVisible: true }
        });
        const candleSeries = chart.addCandlestickSeries({
            upColor: '#22c55e', downColor: '#ef4444', borderVisible: false,
            wickUpColor: '#22c55e', wickDownColor: '#ef4444'
        });

        let history = [];

        // 2. 獲取 CoinW 數據 (使用代理修復 CORS)
        async function updateData() {
            try {
                const proxy = "https://corsproxy.io/?";
                const target = "https://api.coinw.com/api/v1/public?command=returnTicker";
                const response = await fetch(proxy + encodeURIComponent(target));
                const data = await response.json();

                // 解析 CoinW 數據結構 (假設返回為 { "BTCUSDT": { "last": "..." } })
                // 注意：實際結構請依 CoinW 官網為主，若結構不對請聯繫我
                const btc = parseFloat(data.data?.BTCUSDT?.last || data.BTCUSDT?.last || 0);
                const eth = parseFloat(data.data?.ETHUSDT?.last || data.ETHUSDT?.last || 0);

                if (btc > 0) {
                    renderUI('btc', btc);
                    renderUI('eth', eth);
                    processIndicators(btc);
                }
            } catch (err) {
                console.error("API 獲取失敗", err);
                document.getElementById('smc-logs').innerText = "API 請求受阻，嘗試重新連線...";
            }
        }

        function renderUI(coin, price) {
            const el = document.getElementById(`${coin}-price`);
            el.innerText = price.toFixed(2);
            candleSeries.update({
                time: Math.floor(Date.now() / 1000),
                open: price - 1, high: price + 2, low: price - 2, close: price
            });
        }

        // 3. FVG 與 SMC 指標核心邏輯
        function processIndicators(price) {
            history.push({ price, time: Date.now() });
            if (history.length > 20) history.shift();

            const logBox = document.getElementById('smc-logs');
            const adviceBox = document.getElementById('ai-advice');

            // 模擬 FVG 檢測邏輯 (當前價與前段價格有明顯缺口)
            if (Math.abs(price - history[0].price) > 50) {
                const type = price > history[0].price ? "Bullish FVG" : "Bearish FVG";
                logBox.innerHTML = `<div>[${new Date().toLocaleTimeString()}] <span class="text-orange-400">${type}</span> 偵測成功</div>` + logBox.innerHTML;
                
                adviceBox.innerHTML = `⚠️ 偵測到價格失衡。100x 槓桿建議等待回調至 <b>$${(price * 0.999).toFixed(2)}</b> 附近入場。`;
                document.getElementById('entry-val').innerText = (price * 0.999).toFixed(2);
                document.getElementById('sl-val').innerText = (price * 0.994).toFixed(2);
            }
        }

        // 每秒執行一次
        setInterval(updateData, 1000);
        updateData();
    </script>
</body>
</html>
